<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tavus CVI Chat-Only Example</title>
  <script src="https://unpkg.com/@daily-co/daily-js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="header-container">
    <h1>Tavus CVI Chat-Only Example</h1>
    <div class="description">
      <p>Text-only chat interface for Tavus Replicas</p>
      <div class="links">
        <a href="https://docs.tavus.io/sections/event-schemas/conversation-respond">Learn more</a>
        <span class="separator">|</span>
        <a href="https://github.com/andy-tavus/text_chat_only_cvi">View Source Code</a>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="instructions-container">
      <h2>Getting Started</h2>
      <ol>
        <li>Generate a conversation using the <a href="https://docs.tavus.io/api-reference/conversations/create-conversation" target="_blank">Create Conversation API</a> or <a href="https://platform.tavus.io">platform</a></li>
        <li>Enter your conversation ID below</li>
        <li>Click to Start Chat</li>
      </ol>
      <div class="conversation-input">
        <input type="text" id="conversation-id-input" placeholder="Enter conversation ID (e.g., c123abc)" />
        <small class="note">Note: You can also append <code>?conversation_id=YOUR_ID</code> to the URL</small>
      </div>
      <button id="start-btn">Start Chat</button>
    </div>
    
    <div class="video-section">
      <div id="video-container">
        <video id="participant-video" autoplay playsinline></video>
      </div>
      <div id="chat-box">
        <input type="text" id="chat-input" placeholder="Type your message and hit Enter..." />
      </div>
    </div>
  </div>

  <script>
    let callObject = null;
    let participantCheckInterval = null;
    let currentConversationId = null;

    // Extract user_name and conversation_id from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const userName = urlParams.get('user_name') || 'Guest';
    const urlConversationId = urlParams.get('conversation_id');

    // Function to update URL with new conversation ID
    function updateUrlWithConversationId(id) {
      const newUrl = new URL(window.location.href);
      if (id) {
        newUrl.searchParams.set('conversation_id', id);
      } else {
        newUrl.searchParams.delete('conversation_id');
      }
      window.history.replaceState({}, '', newUrl);
    }

    // Function to update input field with conversation ID
    function updateInputWithConversationId(id) {
      document.getElementById('conversation-id-input').value = id || '';
    }

    // If conversation ID exists in URL, populate the input field
    if (urlConversationId) {
      updateInputWithConversationId(urlConversationId);
    }

    // Listen for changes in the input field
    document.getElementById('conversation-id-input').addEventListener('input', (event) => {
      const newId = event.target.value.trim();
      updateUrlWithConversationId(newId);
    });

    // Start Chat Button Listener
    document.getElementById('start-btn').addEventListener('click', () => {
      const conversationId = document.getElementById('conversation-id-input').value.trim();
      if (!conversationId) {
        alert('Please enter a conversation ID');
        return;
      }
      currentConversationId = conversationId;
      initializeChat(conversationId);
      document.getElementById('start-btn').style.display = 'none';
      document.getElementById('video-container').style.display = 'flex';
      document.getElementById('chat-box').style.display = 'flex';
    });

    async function initializeChat(conversationId) {
      const roomUrl = `https://tavus.daily.co/${conversationId}`;
      
      callObject = DailyIframe.createCallObject({
        audioSource: false,
        videoSource: false
      });

      try {
        await callObject.join({ 
          url: roomUrl,
          userName: userName
        });
        console.log(`Joined the call successfully as ${userName}`);

        // Start polling for existing participant
        participantCheckInterval = setInterval(checkForExistingParticipant, 2000);
      } catch (error) {
        console.error('Error joining the call:', error);
        alert('Failed to join the call. Please check the conversation ID.');
      }
    }

    function checkForExistingParticipant() {
      const participants = callObject.participants();
      console.log('Checking for existing participants:', participants);

      const existingParticipant = Object.values(participants).find(
        (participant) => participant.local === false
      );

      if (existingParticipant) {
        console.log(`Participant found: ${existingParticipant.user_id}`);
        subscribeToParticipantStreams(existingParticipant);

        // Stop polling once a participant is found
        clearInterval(participantCheckInterval);
      }
    }

    function subscribeToParticipantStreams(participant) {
      // Subscribe to video
      if (participant.tracks.video.state === 'playable') {
        const videoElement = document.getElementById('participant-video');
        videoElement.srcObject = new MediaStream([participant.tracks.video.persistentTrack]);
      } else {
        console.log('No playable video track for participant.');
      }

      // Subscribe to audio
      if (participant.tracks.audio.state === 'playable') {
        const audioStream = new MediaStream([participant.tracks.audio.persistentTrack]);
        const audio = new Audio();
        audio.srcObject = audioStream;
        audio.autoplay = true;
        console.log('Subscribed to audio track.');
      } else {
        console.log('No playable audio track for participant.');
      }
    }

    // Chat input logic
    document.getElementById('chat-input').addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        const message = event.target.value.trim();
        if (message) {
          sendAppMessage(message);
          event.target.value = ''; // Clear input box
        }
      }
    });

    function sendAppMessage(message) {
      if (!callObject) {
        console.error('Call object is not initialized.');
        return;
      }

      const payload = {
        message_type: "conversation",
        event_type: "conversation.respond",
        conversation_id: currentConversationId,
        properties: {
          text: message
        }
      };

      try {
        callObject.sendAppMessage(payload);
        console.log('Message sent:', payload);
      } catch (error) {
        console.error('Failed to send app message:', error);
      }
    }
  </script>
</body>
</html>
